# Deployment Guide: Embedded Wallets, Gas Sponsorship & Vault

This guide walks you through deploying the complete system with embedded wallets, gas sponsorship, and vault governance.

## Prerequisites

1. **Solana CLI** installed and configured
2. **Anchor** installed (v0.32.1)
3. **Node.js** and npm/pnpm installed
4. **Privy Account** - Sign up at [privy.io](https://privy.io) and create an app

## Step 1: Generate Vault Wallet

```bash
cd backend
npm install
node scripts/generate-vault-wallet.js
```

**Output:**
```
VAULT_WALLET_ADDRESS=<generated_address>
VAULT_WALLET_PRIVATE_KEY=<generated_private_key>
```

**⚠️ IMPORTANT:** 
- Copy these values to your `.env` file
- **Never commit the private key to version control**
- Store the private key securely (use environment variables or secure key management)
- Fund the vault wallet with 10-15 SOL before proceeding

## Step 2: Fund Vault Wallet

Transfer SOL to the vault wallet address:

```bash
solana transfer 5inb57eQXugKNyACDc85w7kUksD15dnHhbRRWuoiEZFh 15 --allow-unfunded-recipient
```

Or use a wallet UI like Phantom to send 10-15 SOL to the address.

## Step 3: Configure Privy

1. Go to [Privy Dashboard](https://dashboard.privy.io)
2. Create a new app or use existing
3. Enable:
   - Email login
   - Google OAuth
   - Twitter/X OAuth
   - Embedded wallets (Solana)
4. Copy your App ID and add to environment variables

## Step 4: Update Environment Variables

### Backend `.env`:
```bash
# Vault (from Step 1 - use values generated by generate-vault-wallet.js)
VAULT_WALLET_ADDRESS=<generated_address>
VAULT_WALLET_PRIVATE_KEY=<generated_private_key>
VAULT_SPONSORSHIP_AMOUNT=10000000  # 0.01 SOL
VAULT_MIN_BALANCE=5000000000  # 5 SOL
```

**⚠️ Security:** Never commit the private key. Use the values generated by the script and store them securely.

# Privy
PRIVY_APP_ID=your_privy_app_id
PRIVY_APP_SECRET=your_privy_app_secret

# Solana
SOLANA_NETWORK=devnet
SOLANA_RPC_URL=https://api.devnet.solana.com
AUTON_PROGRAM_ID=CP4u2AjZeWdjjhxuGUsWLFAqyzGLu8cUU3xdeDnzkqyk
```

### Frontend `.env.local`:
```bash
NEXT_PUBLIC_PRIVY_APP_ID=your_privy_app_id
NEXT_PUBLIC_PRIVY_ENV=production
NEXT_PUBLIC_SOLANA_RPC_URL=https://api.devnet.solana.com
NEXT_PUBLIC_AUTON_PROGRAM_ID=CP4u2AjZeWdjjhxuGUsWLFAqyzGLu8cUU3xdeDnzkqyk
NEXT_PUBLIC_API_URL=http://localhost:3001
```

## Step 5: Deploy Smart Contracts

### Option A: Deploy All Programs (Recommended)

```bash
cd auton_program
./scripts/deploy-all.sh
```

This will:
1. Build all programs
2. Deploy `auton_program`
3. Deploy `sponsor_program`
4. Deploy `vault_governance`

### Option B: Deploy Individually

```bash
cd auton_program

# Build
anchor build

# Deploy auton_program
anchor deploy --provider.cluster devnet --program-name auton_program

# Deploy sponsor_program
anchor deploy --provider.cluster devnet --program-name sponsor_program

# Deploy vault_governance
anchor deploy --provider.cluster devnet --program-name vault_governance
```

**After deployment, update program IDs in:**
- `backend/.env` - Add `SPONSOR_PROGRAM_ID` and `VAULT_GOVERNANCE_PROGRAM_ID`
- `auton_program/Anchor.toml` - Update with actual program IDs

## Step 6: Initialize Vault Governance

After deploying, initialize the vault on-chain:

```bash
cd auton_program

# Set environment variables
export VAULT_WALLET_ADDRESS=5inb57eQXugKNyACDc85w7kUksD15dnHhbRRWuoiEZFh
export ADMIN_WALLET=$(solana address)  # Your admin wallet

# Run initialization script
anchor run initialize-vault
```

Or manually using Anchor:

```bash
anchor run initialize-vault
```

This will:
- Create the vault state PDA
- Set fee percentage to 0.75% (75 basis points)
- Set sponsorship amount to 0.01 SOL
- Set admin wallet

## Step 7: Update Program IDs

After deployment, update the program IDs:

### Backend `.env`:
```bash
SPONSOR_PROGRAM_ID=<deployed_program_id>
VAULT_GOVERNANCE_PROGRAM_ID=<deployed_program_id>
```

### Frontend `.env.local`:
```bash
NEXT_PUBLIC_AUTON_PROGRAM_ID=<deployed_program_id>
```

## Step 8: Test the System

### Test Social Login:
1. Start backend: `cd backend && npm start`
2. Start frontend: `cd frontend && npm run dev`
3. Visit `http://localhost:3000`
4. Click "Continue with Email" or social login
5. Verify wallet is created and linked

### Test Sponsorship:
1. Create a new wallet (or use a fresh one)
2. Try to upload content
3. Verify sponsorship eligibility check
4. Complete first upload (should be sponsored)

### Test Fee Collection:
1. Make a payment for content
2. Check vault wallet balance increased
3. Verify fee was collected (0.75% of payment)

## Step 9: Production Deployment

### Backend (Vercel/Railroad):
1. Set all environment variables in deployment platform
2. **IMPORTANT**: Use secure key management for `VAULT_WALLET_PRIVATE_KEY`
   - Vercel: Use environment variables (encrypted)
   - AWS: Use Secrets Manager
   - Railway: Use encrypted environment variables

### Frontend (Vercel):
1. Set all `NEXT_PUBLIC_*` environment variables
2. Deploy

### Mainnet Deployment:
1. Update `SOLANA_NETWORK=mainnet-beta` in all configs
2. Update RPC URL to mainnet endpoint
3. Deploy programs to mainnet:
   ```bash
   anchor deploy --provider.cluster mainnet-beta --program-name auton_program
   anchor deploy --provider.cluster mainnet-beta --program-name sponsor_program
   anchor deploy --provider.cluster mainnet-beta --program-name vault_governance
   ```
4. Fund vault wallet on mainnet
5. Initialize vault on mainnet

## Troubleshooting

### "Vault wallet not configured"
- Ensure `VAULT_WALLET_ADDRESS` and `VAULT_WALLET_PRIVATE_KEY` are set in backend `.env`

### "Privy features disabled"
- Ensure `NEXT_PUBLIC_PRIVY_APP_ID` is set in frontend `.env.local`

### "Program ID mismatch"
- Rebuild programs: `anchor build`
- Update program IDs in all config files
- Redeploy if needed

### "Insufficient funds for sponsorship"
- Check vault wallet balance: `solana balance <vault_address>`
- Fund if below 5 SOL minimum

### CPI Errors
- Ensure vault_governance is deployed before auton_program
- Verify program IDs are correct
- Check vault state is initialized

## Security Checklist

- [ ] Vault private key stored securely (not in code)
- [ ] Environment variables not committed to git
- [ ] Rate limiting enabled for sponsorship endpoints
- [ ] Abuse detection active
- [ ] Vault balance monitoring set up
- [ ] Admin wallet secured (consider multisig for production)

## Monitoring

Set up monitoring for:
- Vault wallet balance (alert if < 5 SOL)
- Sponsorship rate (alert if > 10/hour)
- Failed transactions
- API errors

## Next Steps

1. Set up monitoring dashboards
2. Configure alerts
3. Test full user flow end-to-end
4. Consider smart contract audit before mainnet
5. Plan for multisig upgrade (Phase 2)

